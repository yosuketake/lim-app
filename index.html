<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>資産成長シミュレーション（投資先切替対応）</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #result { margin-top: 20px; }
    .advice { background: #f0f8ff; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
    .section { margin-top: 15px; }
  </style>
</head>
<body>
  <h2>資産成長シミュレーション（投資先切替対応）</h2>

  <form id="form">
    年齢: <input type="number" id="age" value="35"> 歳<br>
    初期資産: <input type="number" id="initial" value="1000000"> 円<br>
    毎月の投資額: <input type="number" id="monthly" value="50000"> 円<br>
    投資期間(年): <input type="number" id="years" value="30"> 年<br>

    <div class="section">
      <h3>投資対象の切替設定</h3>
      <input type="radio" name="mode" value="default" checked onclick="toggleCustom(false)"> デフォルト設定（40歳/60歳で切替）<br>
      <input type="radio" name="mode" value="custom" onclick="toggleCustom(true)"> カスタム設定<br>

      <div id="customSettings" style="display:none; margin-left:20px;">
        NASDAQ → S&P500 切替年齢: <input type="number" id="toSP" value="40"> 歳<br>
        S&P500 → 米国債 切替年齢: <input type="number" id="toBond" value="60"> 歳<br>
      </div>
    </div>

    <button type="button" onclick="simulate()">シミュレーション開始</button>
  </form>

  <canvas id="chart" width="600" height="400"></canvas>

  <div id="result"></div>

  <script>
    let chart;

    // 平均利回り
    const avgReturns = {
      nasdaq: 0.118,
      sp500: 0.082,
      bonds: 0.035
    };

    // モード切替表示
    function toggleCustom(show) {
      document.getElementById("customSettings").style.display = show ? "block" : "none";
    }

    // 投資対象の判定
    function getAssetAndRate(age, mode, toSP, toBond) {
      if (mode === "default") {
        if (age < 40) return { asset: "NASDAQ", rate: avgReturns.nasdaq };
        else if (age < 60) return { asset: "S&P500", rate: avgReturns.sp500 };
        else return { asset: "米国債", rate: avgReturns.bonds };
      } else {
        if (age < toSP) return { asset: "NASDAQ", rate: avgReturns.nasdaq };
        else if (age < toBond) return { asset: "S&P500", rate: avgReturns.sp500 };
        else return { asset: "米国債", rate: avgReturns.bonds };
      }
    }

    // 金額フォーマット
    function formatNumber(num) {
      return num.toLocaleString("ja-JP");
    }

    function simulate() {
      const startAge = parseInt(document.getElementById("age").value);
      const initial = parseFloat(document.getElementById("initial").value);
      const monthly = parseFloat(document.getElementById("monthly").value);
      const years = parseInt(document.getElementById("years").value);

      // 設定モード
      const mode = document.querySelector('input[name="mode"]:checked').value;
      const toSP = parseInt(document.getElementById("toSP").value);
      const toBond = parseInt(document.getElementById("toBond").value);

      const labels = [];
      const normalCase = [];
      const worstCase = [];
      const assetHistory = [];

      let totalNormal = initial;
      let totalWorst = initial;

      for (let year = 1; year <= years; year++) {
        const currentAge = startAge + year;
        const { asset, rate } = getAssetAndRate(currentAge, mode, toSP, toBond);

        assetHistory.push({ year, age: currentAge, asset });

        // 通常ケース
        totalNormal = (totalNormal + monthly * 12) * (1 + rate);

        // ワーストケース
        if (year % 20 === 0) {
          totalWorst *= 0.6; // 40%下落
        } else if (year % 3 === 0) {
          totalWorst *= 0.8; // 20%下落
        }
        totalWorst = (totalWorst + monthly * 12) * (1 + rate);

        labels.push(year + "年(" + currentAge + "歳)");
        normalCase.push(Math.round(totalNormal));
        worstCase.push(Math.round(totalWorst));
      }

      if (chart) chart.destroy();
      const ctx = document.getElementById("chart").getContext("2d");
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            { label: "通常ケース", data: normalCase, borderColor: "green", fill: false },
            { label: "ワーストケース（3年ごと-20%、20年ごと-40%）", data: worstCase, borderColor: "red", fill: false }
          ]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });

      const finalAsset = assetHistory[assetHistory.length - 1].asset;

      document.getElementById("result").innerHTML = `
        <div class="advice">
          <h3>推奨投資対象</h3>
          投資終了時点では <b>${finalAsset}</b> を推奨します。
        </div>
        <div class="advice">
          <h3>根拠</h3>
          平均利回り：<br>
          NASDAQ: ${(avgReturns.nasdaq*100).toFixed(1)}%<br>
          S&P500: ${(avgReturns.sp500*100).toFixed(1)}%<br>
          米国債: ${(avgReturns.bonds*100).toFixed(1)}%<br>
          本シミュレーションでは、<br>
          ・3年ごとに -20% の下落<br>
          ・20年ごとに -40% の下落（優先）<br>
          を想定しました。
        </div>
      `;
    }
  </script>
</body>
</html>
